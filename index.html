<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡å‹ç¼©å·¥å…· - Image Compressor</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --accent-color: #4CAF50;
            --accent-hover: #45a049;
            --error-color: #f44336;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-card: #252525;
                --text-primary: #e0e0e0;
                --text-secondary: #a0a0a0;
                --border-color: #404040;
                --accent-color: #66BB6A;
                --accent-hover: #5cb860;
                --shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .upload-area {
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .upload-area:hover,
        .upload-area.drag-over {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        .controls {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .control-value {
            color: var(--accent-color);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-secondary);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }

        input[type="number"] {
            width: 120px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .format-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .format-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .format-btn.active {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: var(--accent-color);
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        button:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        button.secondary:hover:not(:disabled) {
            background: var(--border-color);
        }

        .progress-container {
            display: none;
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .progress-container.active {
            display: block;
        }

        .progress-text {
            margin-bottom: 10px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s;
            width: 0%;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .image-card {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .image-card:hover {
            transform: translateY(-5px);
        }

        .image-preview {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(0,0,0,0.6);
            color: white;
        }

        .image-status.processing {
            background: rgba(255, 152, 0, 0.9);
        }

        .image-status.done {
            background: rgba(76, 175, 80, 0.9);
        }

        .image-status.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .image-info {
            padding: 15px;
        }

        .image-name {
            font-weight: 500;
            margin-bottom: 10px;
            word-break: break-all;
            font-size: 0.9rem;
        }

        .image-stats {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .image-stats div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .stat-label {
            font-weight: 500;
        }

        .compression-rate {
            color: var(--accent-color);
            font-weight: 600;
        }

        .image-actions {
            padding: 0 15px 15px;
            display: flex;
            gap: 10px;
        }

        .image-actions button {
            padding: 8px 16px;
            font-size: 0.85rem;
            min-width: auto;
        }

        .error-message {
            background: var(--error-color);
            color: white;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 50px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .beian-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .beian-info a {
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .beian-info a:hover {
            color: var(--text-primary);
        }

        .beian-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }

            .upload-area {
                padding: 40px 20px;
            }

            .action-buttons {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .images-grid {
                grid-template-columns: 1fr;
            }

            .beian-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å›¾ç‰‡å‹ç¼©å·¥å…·</h1>
            <p class="subtitle">çº¯å‰ç«¯å¤„ç† Â· æ”¯æŒ JPEG/PNG/WebP/AVIF Â· æ‰¹é‡å‹ç¼© Â· æœ¬åœ°å®‰å…¨</p>
        </header>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“¸</div>
            <div class="upload-text">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</div>
            <div class="upload-hint">æ”¯æŒ JPEGã€PNGã€WebPã€AVIF æ ¼å¼ï¼Œå¯æ‰¹é‡å¤„ç†</div>
            <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp,image/avif" multiple>
        </div>

        <div class="controls">
            <div class="control-group">
                <div class="control-label">
                    <span>è¾“å‡ºæ ¼å¼</span>
                </div>
                <div class="format-selector">
                    <button class="format-btn active" data-format="original">ä¿æŒåŸæ ¼å¼</button>
                    <button class="format-btn" data-format="jpeg">JPEG</button>
                    <button class="format-btn" data-format="png">PNG</button>
                    <button class="format-btn" data-format="webp">WebP</button>
                    <button class="format-btn" data-format="avif">AVIF</button>
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>å›¾ç‰‡è´¨é‡</span>
                    <span class="control-value" id="qualityValue">0.8</span>
                </div>
                <input type="range" id="qualitySlider" min="0" max="1" step="0.05" value="0.8">
                <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px;">
                    æç¤ºï¼šPNG ä¸ºæ— æŸæ ¼å¼ï¼Œä¸å—è´¨é‡å‚æ•°å½±å“
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>æœ€å¤§å®½åº¦ï¼ˆåƒç´ ï¼Œ0=ä¸é™åˆ¶ï¼‰</span>
                </div>
                <input type="number" id="maxWidth" value="2000" min="0" step="100">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>æœ€å¤§é«˜åº¦ï¼ˆåƒç´ ï¼Œ0=ä¸é™åˆ¶ï¼‰</span>
                </div>
                <input type="number" id="maxHeight" value="2000" min="0" step="100">
            </div>
        </div>

        <div class="action-buttons">
            <button id="compressBtn" disabled>å¼€å§‹å‹ç¼©</button>
            <button id="downloadAllBtn" class="secondary" disabled>ä¸‹è½½å…¨éƒ¨ï¼ˆZIPï¼‰</button>
            <button id="clearBtn" class="secondary" disabled>æ¸…é™¤å…¨éƒ¨</button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-text" id="progressText">å¤„ç†ä¸­... 0/0</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="images-grid" id="imagesGrid"></div>
    </div>

    <footer>
        <div class="beian-info">
            <a href="" rel="noreferrer" target="_blank">
                <img src="beian-icon.png" alt="å…¬å®‰å¤‡æ¡ˆå›¾æ ‡" class="beian-icon">
                äº¬å…¬ç½‘å®‰å¤‡11011202101477å·
            </a>
            <a href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank">
                äº¬ICPå¤‡16005374å·-4
            </a>
        </div>
    </footer>

    <!-- JSZip CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // å…¨å±€çŠ¶æ€
        const state = {
            files: [],
            compressedImages: [],
            settings: {
                quality: 0.8,
                maxWidth: 2000,
                maxHeight: 2000,
                format: 'original'
            }
        };

        // Worker è„šæœ¬ï¼ˆå†…è”ï¼‰
        const workerScript = `
            self.onmessage = async function(e) {
                const { file, settings, index } = e.data;

                try {
                    // è¯»å–æ–‡ä»¶
                    const arrayBuffer = await file.arrayBuffer();
                    const blob = new Blob([arrayBuffer], { type: file.type });

                    // åˆ›å»ºå›¾ç‰‡
                    const imageBitmap = await createImageBitmap(blob);

                    // å¤„ç† EXIF æ—‹è½¬ï¼ˆç®€åŒ–ç‰ˆï¼‰
                    let width = imageBitmap.width;
                    let height = imageBitmap.height;

                    // è®¡ç®—ç¼©æ”¾
                    let targetWidth = width;
                    let targetHeight = height;
                    let needResize = false;

                    if (settings.maxWidth > 0 && targetWidth > settings.maxWidth) {
                        targetHeight = (settings.maxWidth / targetWidth) * targetHeight;
                        targetWidth = settings.maxWidth;
                        needResize = true;
                    }

                    if (settings.maxHeight > 0 && targetHeight > settings.maxHeight) {
                        targetWidth = (settings.maxHeight / targetHeight) * targetWidth;
                        targetHeight = settings.maxHeight;
                        needResize = true;
                    }

                    targetWidth = Math.round(targetWidth);
                    targetHeight = Math.round(targetHeight);

                    // åˆ›å»º canvas å¹¶ç»˜åˆ¶
                    const canvas = new OffscreenCanvas(targetWidth, targetHeight);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(imageBitmap, 0, 0, targetWidth, targetHeight);

                    // ç¡®å®šè¾“å‡ºæ ¼å¼
                    let mimeType = file.type; // é»˜è®¤ä½¿ç”¨åŸæ ¼å¼

                    if (settings.format === 'jpeg') {
                        mimeType = 'image/jpeg';
                    } else if (settings.format === 'png') {
                        mimeType = 'image/png';
                    } else if (settings.format === 'webp') {
                        mimeType = 'image/webp';
                    } else if (settings.format === 'avif') {
                        mimeType = 'image/avif';
                    }
                    // 'original' æ ¼å¼ä¿æŒåŸæœ‰çš„ mimeType

                    // å¯¼å‡ºä¸º blob
                    // PNG æ ¼å¼å¿½ç•¥ quality å‚æ•°ï¼ˆæ— æŸæ ¼å¼ï¼‰
                    const exportOptions = { type: mimeType };
                    if (mimeType !== 'image/png') {
                        exportOptions.quality = settings.quality;
                    }

                    const compressedBlob = await canvas.convertToBlob(exportOptions);

                    // æ™ºèƒ½ä¼˜åŒ–ï¼šå¦‚æœå‹ç¼©åæ›´å¤§ï¼Œä½¿ç”¨åŸå›¾
                    let finalBlob = compressedBlob;
                    let usedOriginal = false;

                    // æ¡ä»¶1: å°ºå¯¸æœªæ”¹å˜ä¸”å‹ç¼©åä½“ç§¯å¢å¤§ï¼Œä½¿ç”¨åŸå›¾
                    // æ¡ä»¶2: æ ¼å¼æœªæ”¹å˜ï¼ˆä¿æŒåŸæ ¼å¼ï¼‰ä¸”ä½“ç§¯å¢å¤§è¶…è¿‡ 5%ï¼Œä½¿ç”¨åŸå›¾
                    const sizeIncrease = (compressedBlob.size - file.size) / file.size;
                    if (!needResize && compressedBlob.size >= file.size) {
                        if (settings.format === 'original' || sizeIncrease > 0.05) {
                            // å°ºå¯¸æœªæ”¹å˜ä¸”å‹ç¼©åæ›´å¤§ï¼Œæˆ–ä½“ç§¯å¢å¤§è¶…è¿‡5%ï¼Œä½¿ç”¨åŸå›¾
                            finalBlob = blob;
                            usedOriginal = true;
                        }
                    }

                    // è¿”å›ç»“æœ
                    self.postMessage({
                        success: true,
                        index: index,
                        originalSize: file.size,
                        compressedSize: finalBlob.size,
                        originalWidth: width,
                        originalHeight: height,
                        compressedWidth: targetWidth,
                        compressedHeight: targetHeight,
                        blob: finalBlob,
                        fileName: file.name,
                        usedOriginal: usedOriginal,
                        originalType: file.type,
                        outputType: mimeType
                    });
                } catch (error) {
                    self.postMessage({
                        success: false,
                        index: index,
                        error: error.message,
                        fileName: file.name
                    });
                }
            };
        `;

        // åˆ›å»º Worker
        const createWorker = () => {
            const blob = new Blob([workerScript], { type: 'application/javascript' });
            return new Worker(URL.createObjectURL(blob));
        };

        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagesGrid = document.getElementById('imagesGrid');
        const compressBtn = document.getElementById('compressBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const clearBtn = document.getElementById('clearBtn');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const maxWidthInput = document.getElementById('maxWidth');
        const maxHeightInput = document.getElementById('maxHeight');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const formatBtns = document.querySelectorAll('.format-btn');

        // æ–‡ä»¶é€‰æ‹©
        uploadArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                return file.type.match(/^image\/(jpeg|png|webp|avif)$/);
            });

            if (validFiles.length === 0) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆJPEGã€PNGã€WebP æˆ– AVIFï¼‰');
                return;
            }

            state.files.push(...validFiles);
            state.compressedImages.push(...validFiles.map(() => null));

            renderImages();
            updateButtons();
        }

        // æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
        function renderImages() {
            imagesGrid.innerHTML = '';

            state.files.forEach((file, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.id = `image-card-${index}`;

                const preview = document.createElement('div');
                preview.className = 'image-preview';

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                preview.appendChild(img);

                const status = document.createElement('div');
                status.className = 'image-status';
                status.textContent = 'å¾…å¤„ç†';
                status.id = `status-${index}`;
                preview.appendChild(status);

                card.appendChild(preview);

                const info = document.createElement('div');
                info.className = 'image-info';

                const name = document.createElement('div');
                name.className = 'image-name';
                name.textContent = file.name;
                info.appendChild(name);

                const stats = document.createElement('div');
                stats.className = 'image-stats';
                stats.id = `stats-${index}`;
                stats.innerHTML = `
                    <div><span class="stat-label">åŸå§‹å¤§å°:</span> <span>${formatFileSize(file.size)}</span></div>
                    <div><span class="stat-label">çŠ¶æ€:</span> <span>ç­‰å¾…å‹ç¼©</span></div>
                `;
                info.appendChild(stats);

                card.appendChild(info);

                const actions = document.createElement('div');
                actions.className = 'image-actions';
                actions.id = `actions-${index}`;
                actions.innerHTML = `
                    <button onclick="removeImage(${index})">ç§»é™¤</button>
                `;
                card.appendChild(actions);

                imagesGrid.appendChild(card);
            });
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ç§»é™¤å›¾ç‰‡
        window.removeImage = function(index) {
            state.files.splice(index, 1);
            state.compressedImages.splice(index, 1);
            renderImages();
            updateButtons();
        };

        // ä¸‹è½½å•å¼ å›¾ç‰‡
        window.downloadImage = function(index) {
            const compressed = state.compressedImages[index];
            if (!compressed) return;

            const link = document.createElement('a');
            link.href = URL.createObjectURL(compressed.blob);

            // æ ¹æ®å®é™…è¾“å‡ºç±»å‹ç¡®å®šæ‰©å±•å
            let ext = 'jpg';
            if (compressed.outputType === 'image/png') {
                ext = 'png';
            } else if (compressed.outputType === 'image/webp') {
                ext = 'webp';
            } else if (compressed.outputType === 'image/avif') {
                ext = 'avif';
            } else if (compressed.outputType === 'image/jpeg') {
                ext = 'jpg';
            }

            link.download = `compressed_${Date.now()}_${index}.${ext}`;
            link.click();
        };

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons() {
            compressBtn.disabled = state.files.length === 0;
            clearBtn.disabled = state.files.length === 0;
            downloadAllBtn.disabled = state.compressedImages.filter(x => x).length === 0;
        }

        // è´¨é‡æ»‘å—
        qualitySlider.addEventListener('input', (e) => {
            state.settings.quality = parseFloat(e.target.value);
            qualityValue.textContent = state.settings.quality.toFixed(2);
        });

        // å°ºå¯¸è¾“å…¥
        maxWidthInput.addEventListener('change', (e) => {
            state.settings.maxWidth = parseInt(e.target.value) || 0;
        });

        maxHeightInput.addEventListener('change', (e) => {
            state.settings.maxHeight = parseInt(e.target.value) || 0;
        });

        // æ ¼å¼é€‰æ‹©
        formatBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                formatBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.settings.format = btn.dataset.format;
            });
        });

        // å¼€å§‹å‹ç¼©
        compressBtn.addEventListener('click', async () => {
            compressBtn.disabled = true;
            progressContainer.classList.add('active');

            let completed = 0;
            const total = state.files.length;

            // ä½¿ç”¨ Worker å¤„ç†æ¯å¼ å›¾ç‰‡
            const processImage = (file, index) => {
                return new Promise((resolve) => {
                    const worker = createWorker();

                    // æ›´æ–°çŠ¶æ€
                    const statusEl = document.getElementById(`status-${index}`);
                    if (statusEl) {
                        statusEl.textContent = 'å¤„ç†ä¸­';
                        statusEl.className = 'image-status processing';
                    }

                    worker.onmessage = (e) => {
                        const result = e.data;

                        if (result.success) {
                            state.compressedImages[index] = result;

                            // æ›´æ–°ç•Œé¢
                            if (statusEl) {
                                statusEl.textContent = 'å®Œæˆ';
                                statusEl.className = 'image-status done';
                            }

                            const statsEl = document.getElementById(`stats-${index}`);
                            if (statsEl) {
                                const compressionRate = ((1 - result.compressedSize / result.originalSize) * 100).toFixed(1);
                                const rateColor = compressionRate > 0 ? 'var(--accent-color)' : 'var(--error-color)';

                                let warningMsg = '';
                                if (result.usedOriginal) {
                                    warningMsg = '<div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">âš ï¸ å·²ä½¿ç”¨åŸå›¾ï¼ˆå‹ç¼©åæ›´å¤§ï¼‰</div>';
                                } else if (compressionRate < 0) {
                                    warningMsg = '<div style="color: var(--error-color); font-size: 0.8rem; margin-top: 5px;">âš ï¸ å‹ç¼©åä½“ç§¯å¢å¤§ï¼Œå»ºè®®è°ƒæ•´è®¾ç½®</div>';
                                }

                                statsEl.innerHTML = `
                                    <div><span class="stat-label">åŸå§‹:</span> <span>${result.originalWidth}Ã—${result.originalHeight} (${formatFileSize(result.originalSize)})</span></div>
                                    <div><span class="stat-label">å‹ç¼©å:</span> <span>${result.compressedWidth}Ã—${result.compressedHeight} (${formatFileSize(result.compressedSize)})</span></div>
                                    <div><span class="stat-label">å‹ç¼©ç‡:</span> <span class="compression-rate" style="color: ${rateColor}">${compressionRate}%</span></div>
                                    ${warningMsg}
                                `;
                            }

                            const actionsEl = document.getElementById(`actions-${index}`);
                            if (actionsEl) {
                                actionsEl.innerHTML = `
                                    <button onclick="downloadImage(${index})">ä¸‹è½½</button>
                                    <button onclick="removeImage(${index})">ç§»é™¤</button>
                                `;
                            }
                        } else {
                            // é”™è¯¯å¤„ç†
                            if (statusEl) {
                                statusEl.textContent = 'å¤±è´¥';
                                statusEl.className = 'image-status error';
                            }

                            const statsEl = document.getElementById(`stats-${index}`);
                            if (statsEl) {
                                statsEl.innerHTML = `<div class="error-message">é”™è¯¯: ${result.error}</div>`;
                            }
                        }

                        completed++;
                        updateProgress(completed, total);

                        worker.terminate();
                        resolve();
                    };

                    worker.postMessage({
                        file: file,
                        settings: state.settings,
                        index: index
                    });
                });
            };

            // æ‰¹é‡å¤„ç†ï¼ˆæ§åˆ¶å¹¶å‘æ•°ï¼‰
            const concurrency = 3;
            for (let i = 0; i < total; i += concurrency) {
                const batch = state.files.slice(i, i + concurrency);
                const promises = batch.map((file, batchIndex) =>
                    processImage(file, i + batchIndex)
                );
                await Promise.all(promises);
            }

            progressContainer.classList.remove('active');
            compressBtn.disabled = false;
            updateButtons();
        });

        // æ›´æ–°è¿›åº¦
        function updateProgress(completed, total) {
            const percent = (completed / total * 100).toFixed(0);
            progressText.textContent = `å¤„ç†ä¸­... ${completed}/${total} (${percent}%)`;
            progressFill.style.width = `${percent}%`;
        }

        // ä¸‹è½½å…¨éƒ¨ï¼ˆZIPï¼‰
        downloadAllBtn.addEventListener('click', async () => {
            if (typeof JSZip === 'undefined') {
                alert('JSZip åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            downloadAllBtn.disabled = true;
            downloadAllBtn.textContent = 'æ‰“åŒ…ä¸­...';

            try {
                const zip = new JSZip();

                state.compressedImages.forEach((compressed, index) => {
                    if (compressed && compressed.blob) {
                        // æ ¹æ®å®é™…è¾“å‡ºç±»å‹ç¡®å®šæ‰©å±•å
                        let ext = 'jpg';
                        if (compressed.outputType === 'image/png') {
                            ext = 'png';
                        } else if (compressed.outputType === 'image/webp') {
                            ext = 'webp';
                        } else if (compressed.outputType === 'image/avif') {
                            ext = 'avif';
                        } else if (compressed.outputType === 'image/jpeg') {
                            ext = 'jpg';
                        }

                        const fileName = `compressed_${index + 1}.${ext}`;
                        zip.file(fileName, compressed.blob);
                    }
                });

                const content = await zip.generateAsync({ type: 'blob' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `compressed_images_${Date.now()}.zip`;
                link.click();

                downloadAllBtn.textContent = 'ä¸‹è½½å…¨éƒ¨ï¼ˆZIPï¼‰';
            } catch (error) {
                alert('æ‰“åŒ…å¤±è´¥: ' + error.message);
            } finally {
                downloadAllBtn.disabled = false;
            }
        });

        // æ¸…é™¤å…¨éƒ¨
        clearBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ')) {
                state.files = [];
                state.compressedImages = [];
                renderImages();
                updateButtons();
                fileInput.value = '';
            }
        });

        // åˆå§‹åŒ–
        updateButtons();
    </script>
</body>
</html>
